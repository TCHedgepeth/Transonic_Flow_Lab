clc;
clear all;
close all;
format short g;

% initializing airfoil data points

% NACA 0012:

x0t = [0;0.000583900000000000;0.00233420000000000;0.00524680000000000;0.00931490000000000;0.0145291000000000;0.0208771000000000;0.0283441000000000;0.0369127000000000;0.0465628000000000;0.0572720000000000;0.0690152000000000;0.0817649000000000;0.0954915000000000;0.110162800000000;0.125744600000000;0.142200500000000;0.159492100000000;0.177578900000000;0.196418700000000;0.215967600000000;0.236179900000000;0.257008300000000;0.278404200000000;0.300317700000000;0.322697600000000;0.345491500000000;0.368646300000000;0.392107900000000;0.415821500000000;0.439731700000000;0.463782600000000;0.487918100000000;0.512081900000000;0.536217400000000;0.560268300000000;0.584178600000000;0.607892100000000;0.631353700000000;0.654508500000000;0.677302500000000;0.699682300000000;0.721595800000000;0.742991700000000;0.763820200000000;0.784032400000000;0.803581300000000;0.822421100000000;0.840507900000000;0.857799500000000;0.874255400000000;0.889837200000000;0.904508500000000;0.918235100000000;0.930984900000000;0.942728000000000;0.953437200000000;0.963087300000000;0.971655900000000;0.979122900000000;0.985470900000000;0.990685000000000;0.994753200000000;0.997665800000000;0.999416100000000;1];
z0t = [0;0.00426030000000000;0.00842890000000000;0.0125011000000000;0.0164706000000000;0.0203300000000000;0.0240706000000000;0.0276827000000000;0.0311559000000000;0.0344792000000000;0.0376414000000000;0.0406310000000000;0.0434371000000000;0.0460489000000000;0.0484567000000000;0.0506513000000000;0.0526251000000000;0.0543715000000000;0.0558856000000000;0.0571640000000000;0.0582048000000000;0.0590081000000000;0.0595755000000000;0.0599102000000000;0.0600172000000000;0.0599028000000000;0.0595747000000000;0.0590419000000000;0.0583145000000000;0.0574033000000000;0.0563200000000000;0.0550769000000000;0.0536866000000000;0.0521620000000000;0.0505161000000000;0.0487619000000000;0.0469124000000000;0.0449802000000000;0.0429778000000000;0.0409174000000000;0.0388109000000000;0.0366700000000000;0.0345058000000000;0.0323294000000000;0.0301515000000000;0.0279828000000000;0.0258337000000000;0.0237142000000000;0.0216347000000000;0.0196051000000000;0.0176353000000000;0.0157351000000000;0.0139143000000000;0.0121823000000000;0.0105485000000000;0.00902170000000000;0.00761080000000000;0.00632380000000000;0.00516850000000000;0.00415190000000000;0.00328040000000000;0.00255950000000000;0.00199380000000000;0.00158700000000000;0.00134190000000000;0.00126000000000000];

x0b = [0;0.000583900000000000;0.00233420000000000;0.00524680000000000;0.00931490000000000;0.0145291000000000;0.0208771000000000;0.0283441000000000;0.0369127000000000;0.0465628000000000;0.0572720000000000;0.0690152000000000;0.0817649000000000;0.0954915000000000;0.110162800000000;0.125744600000000;0.142200500000000;0.159492100000000;0.177578900000000;0.196418700000000;0.215967600000000;0.236179900000000;0.257008300000000;0.278404200000000;0.300317700000000;0.322697600000000;0.345491500000000;0.368646300000000;0.392107900000000;0.415821500000000;0.439731700000000;0.463782600000000;0.487918100000000;0.512081900000000;0.536217400000000;0.560268300000000;0.584178600000000;0.607892100000000;0.631353700000000;0.654508500000000;0.677302500000000;0.699682300000000;0.721595800000000;0.742991700000000;0.763820200000000;0.784032400000000;0.803581300000000;0.822421100000000;0.840507900000000;0.857799500000000;0.874255400000000;0.889837200000000;0.904508500000000;0.918235100000000;0.930984900000000;0.942728000000000;0.953437200000000;0.963087300000000;0.971655900000000;0.979122900000000;0.985470900000000;0.990685000000000;0.994753200000000;0.997665800000000;0.999416100000000;1];
z0b = -[0;0.00426030000000000;0.00842890000000000;0.0125011000000000;0.0164706000000000;0.0203300000000000;0.0240706000000000;0.0276827000000000;0.0311559000000000;0.0344792000000000;0.0376414000000000;0.0406310000000000;0.0434371000000000;0.0460489000000000;0.0484567000000000;0.0506513000000000;0.0526251000000000;0.0543715000000000;0.0558856000000000;0.0571640000000000;0.0582048000000000;0.0590081000000000;0.0595755000000000;0.0599102000000000;0.0600172000000000;0.0599028000000000;0.0595747000000000;0.0590419000000000;0.0583145000000000;0.0574033000000000;0.0563200000000000;0.0550769000000000;0.0536866000000000;0.0521620000000000;0.0505161000000000;0.0487619000000000;0.0469124000000000;0.0449802000000000;0.0429778000000000;0.0409174000000000;0.0388109000000000;0.0366700000000000;0.0345058000000000;0.0323294000000000;0.0301515000000000;0.0279828000000000;0.0258337000000000;0.0237142000000000;0.0216347000000000;0.0196051000000000;0.0176353000000000;0.0157351000000000;0.0139143000000000;0.0121823000000000;0.0105485000000000;0.00902170000000000;0.00761080000000000;0.00632380000000000;0.00516850000000000;0.00415190000000000;0.00328040000000000;0.00255950000000000;0.00199380000000000;0.00158700000000000;0.00134190000000000;0.00126000000000000];

tc0 = .12;

% RAE 5214:

x5t = [0;0.000500000000000000;0.00100000000000000;0.00160000000000000;0.00241000000000000;0.00350000000000000;0.00500000000000000;0.00650000000000000;0.00800000000000000;0.00961000000000000;0.0150000000000000;0.0215300000000000;0.0300000000000000;0.0380600000000000;0.0590400000000000;0.0842700000000000;0.113490000000000;0.146450000000000;0.182800000000000;0.222210000000000;0.264300000000000;0.308660000000000;0.354860000000000;0.402450000000000;0.450990000000000;0.500000000000000;0.549010000000000;0.597550000000000;0.645140000000000;0.691340000000000;0.735700000000000;0.777790000000000;0.817200000000000;0.853550000000000;0.886510000000000;0.915730000000000;0.940960000000000;0.961940000000000;0.978470000000000;0.990390000000000;0.997590000000000;1];
z5t = [0;0.00522000000000000;0.00732000000000000;0.00925000000000000;0.0112800000000000;0.0134300000000000;0.0158000000000000;0.0177800000000000;0.0194000000000000;0.0209000000000000;0.0248000000000000;0.0284100000000000;0.0321600000000000;0.0349600000000000;0.0402900000000000;0.0443400000000000;0.0477600000000000;0.0504500000000000;0.0527600000000000;0.0548000000000000;0.0564000000000000;0.0574400000000000;0.0577800000000000;0.0574200000000000;0.0564200000000000;0.0547800000000000;0.0523400000000000;0.0491700000000000;0.0452400000000000;0.0407100000000000;0.0358600000000000;0.0308200000000000;0.0258100000000000;0.0209400000000000;0.0164100000000000;0.0123600000000000;0.00870000000000000;0.00562000000000000;0.00302000000000000;0.00133000000000000;0.000340000000000000;0];

x5b = [0;0.000500000000000000;0.00100000000000000;0.00160000000000000;0.00241000000000000;0.00350000000000000;0.00500000000000000;0.00650000000000000;0.00800000000000000;0.00961000000000000;0.0150000000000000;0.0215300000000000;0.0300000000000000;0.0380600000000000;0.0590400000000000;0.0842700000000000;0.113490000000000;0.146450000000000;0.182800000000000;0.222210000000000;0.264300000000000;0.308660000000000;0.354860000000000;0.402450000000000;0.450990000000000;0.500000000000000;0.549010000000000;0.597550000000000;0.645140000000000;0.691340000000000;0.735700000000000;0.777790000000000;0.817200000000000;0.853550000000000;0.886510000000000;0.915730000000000;0.940960000000000;0.961940000000000;0.978470000000000;0.990390000000000;0.997590000000000;1];
z5b = -[0;-0.00410000000000000;-0.00545000000000000;-0.00665000000000000;-0.00785000000000000;-0.00900000000000000;-0.0103000000000000;-0.0113900000000000;-0.0122800000000000;-0.0131600000000000;-0.0153300000000000;-0.0172700000000000;-0.0194700000000000;-0.0211800000000000;-0.0245900000000000;-0.0278600000000000;-0.0307400000000000;-0.0333200000000000;-0.0355600000000000;-0.0373100000000000;-0.0385600000000000;-0.0391500000000000;-0.0388900000000000;-0.0377300000000000;-0.0356000000000000;-0.0323200000000000;-0.0278800000000000;-0.0226700000000000;-0.0171600000000000;-0.0119900000000000;-0.00768000000000000;-0.00424000000000000;-0.00175000000000000;-0.000100000000000000;0.000850000000000000;0.00130000000000000;0.00126000000000000;0.000980000000000000;0.000620000000000000;0.000290000000000000;6.00000000000000e-05;0];

tc5 = .097;

%  plot(x0t,z0t,x0b,z0b)
%  axis equal
%  xlabel('x')
%  ylabel('y');
%  
%  plot(x5t,z5t,x5b,-z5b)
%  axis equal
%  xlabel('x')
%  ylabel('y');

% initializing grid space
dx = .05;
dy = dx;
x = -6:dx:6;
y = 0:dy:12;

% adding airfoil geometry to grid space
query_points = (0:dx:1);
interp_x_points = interp1(x0t,x0t,query_points,'spline'); 
interp_y_points = interp1(x0t,z0t,query_points,'spline');

x_points = zeros(size(x));
y_points = zeros(size(y));
q = length(x);
p = length(y);

for i=1:21
    x_points(i+(q-1)/2-10) = interp_x_points(i);
    y_points(i+(q-1)/2-10) = interp_y_points(i);
end


% initializing matrices and vectors
phi_star = zeros(q,p);
phi = zeros(q,p);
phix = zeros(q,p);
u = zeros(q,p);
cp = zeros(size(phi_star(:,1)));
dfdx = zeros(1,q);
B = zeros(q,p);
supersonic_points = zeros(size(x));
black_line = supersonic_points;

yeT = max(y);
xeL = min(x); 
xeR = max(x);
 
% calculating df/dx values
for i = ((q-1)/2)-10:1:((q-1)/2)+11;
    dfdx(i) = (y_points(i+1)-y_points(i-1))/(2*dx); % central
end

dfdx(((q-1)/2)-9) = (y_points(((q-1)/2)-9-2)-4*y_points(((q-1)/2)-9-1)+3*y_points(((q-1)/2)-9))/(2*dx); % backward

dfdx(((q-1)/2)+12) = (-y_points(((q-1)/2)+12+2)+4*y_points(((q-1)/2)+12+1)-3*y_points(((q-1)/2)+12))/(2*dx); % forward
 

% initializing constants
g = 1.4;
a = 340.29;

% initializing airfoil and Mach number choices
tc = tc5;
M = [.4 .6 .8 .85 .9]; 
cd = [0,0,0,0,0];
cl = [0,0,0,0,0];

M = [.76 .77 .78 .79 .80]; 


for r = 1:length(M)
 
    % initalizing error and iteration choices
    error = 2;
    error_allowed = .1;
    iterations = 1;
    maxiterations = 200;
    
    %calculating U_infinity
    Uinf = a*M(r);
    
    while error>error_allowed && iterations<maxiterations
    
         % calculating phix matrix
         for j=1:p
            phix(1,j)=(-phi(3,1)+4*phi(2,1)-3*phi(1,1))/(2*dx); % forward
            
            phix(q,j)=(phi(q-2,j)-4*phi(q-1,j)+3*phi(q,j))/(2*dx); % backward
            
            for i=2:q-1
                phix(i,j)=(phi(i+1,j)-phi(i-1,j))/(2*dx); % central
            end
         end
      
         
        % calculating doublet strength 
        D = (tc*Uinf*trapz(y_points)*dx)+((g+1)/2)*((1/(tc*Uinf))*trapz(trapz(phix.^2)*dx)*dy);
        
        
        % calculating boundary conditions
        for j = 1:p;
            phi_star(1,j) = D/(2*pi)*(xeL/(xeL^2 + y(j)^2)); % left
            phi_star(q,j) = D/(2*pi)*(xeR/(xeR^2 + y(j)^2)); % right
        end
        
        for i=2:q-1
            phi_star(i,max(p))=(D/(2*pi))*x(i)/(x(i)^2+yeT^2); % top
        end 
            
                
        % calculating B values
        for i = 1:q
            for j = 1:p
                B(i,j) = 1-M(r)^2-(M(r)^2/Uinf)*(g+1)*phix(i,j);
            end
        end
        
        % calculating bottom boundary
        for i=2:q-1
            if B(i,1)>0 % subsonic
                phi_star(i,1) = (B(i,1)/dx^2*(phi_star(i-1,1)+phi_star(i+1,1))+1/dy^2*(2*phi_star(i,1+1)-2*dy*Uinf*dfdx(i)))/(2*B(i,1)/dx^2+2/dy^2);
            elseif B(i,1)<0 % supersonic
                phi_star(i,1) = (B(i,1)/dx^2*(-2*phi_star(i-1,1)+phi_star(i-2,1))+1/dy^2*(2*phi_star(i,1+1)-2*dy*Uinf*dfdx(i)))/(-B(i,1)/dx^2+2/dy^2);
                
                %r
                % calculating supersonic region over airfoil
                %supersonic_points(i) = (r+1)/10;
            end
        end
        
        % calculating interior points
        for i=2:q-1
            for j=2:p-1
               if B(i,j)>0 % subsonic
                   phi_star(i,j) = ((B(i,j)/dx^2)*(phi_star(i+1,j)+phi_star(i-1,j))+1/dy^2*(phi_star(i,j+1)+phi_star(i,j-1)))/(2*B(i,j)/dx^2+2/dy^2);
               else   % supersonic
                   phi_star(i,j) = (B(i,j)/dx^2*(-2*phi_star(i-1,j)+phi_star(i-2,j))+1/dy^2*(phi_star(i,j+1)+phi_star(i,j-1)))/(-B(i,j)/dx^2+2/dy^2);
               end
            end
        end
        
        error = norm(abs(phi_star-phi));
        iterations = iterations + 1;
        phi = phi_star;
              
    end
    
    % calculating cp
    for i=1:q
         cp(i)=-(2*phix(i,1))./Uinf;
    end
    
    
%     % calculating lift and drag
%     alpha = 0;
%     cfy=trapz(x_points,-cp);
%     cfx=trapz(y_points,cp);
%     cd(r) = cfx*cos(alpha)+cfy*sin(alpha);
%     cl(r) = cfy*cos(alpha)+cfx*sin(alpha);
%     
%     
    figure(1)
    plot(x,cp);
    axis ij
    axis([-1 1 -.8 .6]);
    if r == 5;
        xlabel('x')
        ylabel('Cp')
        legend('M=0.4','M=0.6','M=0.8','M=0.85','M=0.9')
    else
    end
    hold all
%     
%     figure(2)
%     plot(x,phi_star(:,1))
%     axis([-1 1 -30 60]);
%     if r == 5;
%         legend('M=0.4','M=0.6','M=0.8','M=0.85','M=0.9')
%         xlabel('x')
%         ylabel('Phi')
%     else
%     end
%     hold all
%     
%     figure(3)
%     plot(x,phix(:,1))
%     axis([-1 1 -75 120]);
%     if r == 5;
%         legend('M=0.4','M=0.6','M=0.8','M=0.85','M=0.9')
%         xlabel('x')
%         ylabel('Phix')
%     else
%     end
%     hold all
    
%     figure(4)
%     plot(x,supersonic_points(:))
%     axis([-.6 .6 -.3 .7]);
%     if r == 5;
%         legend('M=0.4','M=0.6','M=0.8','M=0.85','M=0.9')
%         xlabel('x')
%         ylabel('y');
%         plot(x0t-.5,z0t,'k',x0b-.5,z0b,'k',x,black_line,'k')
%     else
%     end
%     hold all
    
    
    iterations_this_run = iterations
end

%  figure (4)
%  plot(M,cd)
%  xlabel('Mach Number')
%  ylabel('Coefficient of Drag');
    
